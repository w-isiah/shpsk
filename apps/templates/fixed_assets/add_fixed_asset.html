{% extends "layouts/base.html" %}

{% block title %}Add Fixed Asset{% endblock %}
{% block body_class %}hold-transition sidebar-mini layout-footer-fixed{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
<link rel="stylesheet" href="/static/assets/plugins/fontawesome-free/css/all.min.css">
<link rel="stylesheet" href="/static/assets/css/adminlte.min.css">
<link href="/static/assets/css/select2.min.css" rel="stylesheet" />
<style>
  .alert-container {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    width: 80%;
    display: none;
  }
  .img-thumb { width: 100px; height: 100px; object-fit: cover; }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="alert-container" id="flashMessageContainer">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          <strong>{{ message }}</strong>
          <button type="button" class="close" data-dismiss="alert">&times;</button>
        </div>
      {% endfor %}
    </div>
    {% endif %}
  {% endwith %}

  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6"><h1>Add Fixed Asset</h1></div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="/index">Home</a></li>
            <li class="breadcrumb-item"><a href="/fixed_assets">Fixed Assets</a></li>
            <li class="breadcrumb-item active">Add Fixed Asset</li>
          </ol>
        </div>
      </div>
    </div>
  </section>

  <section class="content">
    <div class="container-fluid">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="card-title mb-0">Add New Fixed Asset</h3>
          <div class="btn-group">
            <a href="/fixed_assets" class="btn btn-primary btn-sm">Asset List</a>
          </div>
        </div>

        <div class="card-body">
          <form action="{{ url_for('fixed_assets_blueprint.add_fixed_asset') }}" method="POST" enctype="multipart/form-data" class="form-horizontal">
            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">

            <!-- Department -->
            <div class="form-group row">
              <label for="department_id" class="col-sm-2 col-form-label">Department</label>
              <div class="col-sm-10">
                <select name="department_id" id="department_id" class="form-control select2" required>
                  <option value="">Select a Department</option>
                  {% for d in departments %}
                    <option value="{{ d.department_id }}">{{ d.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <!-- Section -->
            <div class="form-group row" id="section_container" style="display: none;">
              <label for="section_id" class="col-sm-2 col-form-label">Section</label>
              <div class="col-sm-10">
                <select name="section_id" id="section_id" class="form-control select2">
                  <option value="">Select a Section</option>
                </select>
              </div>
            </div>

            <!-- Identification Number -->
            <div class="form-group row">
              <label class="col-sm-2 col-form-label">Identification #</label>
              <div class="col-sm-10">
                <input type="text" name="identification_number" value="{{ random_num }}" class="form-control" required />
              </div>
            </div>

            <!-- Serial Number -->
            <div class="form-group row">
              <label class="col-sm-2 col-form-label">Serial #</label>
              <div class="col-sm-10">
                <input type="text" name="serial_number" class="form-control" />
              </div>
            </div>

            <!-- Description -->
            <div class="form-group row">
              <label class="col-sm-2 col-form-label">Description</label>
              <div class="col-sm-10">
                <textarea name="description" class="form-control"></textarea>
              </div>
            </div>

            <!-- Supplier -->
            <div class="form-group row">
              <label for="supplier_id" class="col-sm-2 col-form-label">Supplier</label>
              <div class="col-sm-10">
                <select name="supplier_id" id="supplier_id" class="form-control select2">
                  <option value="">Select a Supplier</option>
                  {% for s in suppliers %}
                    <option value="{{ s.SupplierID }}">{{ s.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <!-- Custodian -->
            <div class="form-group row">
              <label for="custodian_id" class="col-sm-2 col-form-label">Custodian</label>
              <div class="col-sm-10">
                <select name="custodian_id" id="custodian_id" class="form-control select2">
                  <option value="">Select a Custodian</option>
                  {% for c in custodians %}
                    <option value="{{ c.id }}">{{ c.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <!-- Ownership Status -->
            <div class="form-group row">
              <label class="col-sm-2 col-form-label">Ownership</label>
              <div class="col-sm-10">
                <input type="text" name="ownership_status" class="form-control" />
              </div>
            </div>

            <!-- Asset Condition -->
            <div class="form-group row">
              <label class="col-sm-2 col-form-label">Condition</label>
              <div class="col-sm-10">
                <input type="text" name="asset_condition" class="form-control" />
              </div>
            </div>

            <!-- Image -->
            <div class="form-group row">
              <label class="col-sm-2 col-form-label">Asset Image</label>
              <div class="col-sm-10">
                <input type="file" name="image" class="form-control" accept="image/*" />
              </div>
            </div>

            <!-- Submit -->
            <div class="form-group row">
              <div class="col-sm-12 text-end">
                <button type="submit" class="btn btn-success">Save</button>
              </div>
            </div>
          </form>
        </div>

        <div class="card-footer text-center">
          Footer Content
        </div>
      </div>
    </div>
  </section>
</div>
{% endblock content %}

{% block javascripts %}
<script src="/static/assets/plugins/jquery/jquery.min.js"></script>
<script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/static/assets/js/adminlte.min.js"></script>
<script src="/static/assets/js/select2.min.js"></script>

<script>
$(document).ready(function () {
  $('.select2').select2();

  // Flash message fade
  const flashMessageContainer = $('#flashMessageContainer');
  if (flashMessageContainer.length) {
    flashMessageContainer.fadeIn(300).delay(3000).fadeOut(1000);
  }

  // Section dropdown depends on Department
  let allSections = {{ sections | tojson }};

  function updateSectionDropdown() {
    const selectedDept = $('#department_id').val();
    const sectionSelect = $('#section_id');
    const sectionContainer = $('#section_container');

    sectionSelect.empty().append('<option value="">Select a Section</option>');
    sectionContainer.hide();

    if (!selectedDept) return;

    const filtered = allSections.filter(s => s.department_id == selectedDept);
    if (filtered.length) {
      filtered.forEach(s => {
        sectionSelect.append(`<option value="${s.section_id}">${s.name}</option>`);
      });
      sectionContainer.show();
    }
  }

  $('#department_id').on('change', updateSectionDropdown);
});
</script>
{% endblock javascripts %}
