{% extends "layouts/base.html" %}

{% block title %}Fixed Assets List{% endblock %}
{% block body_class %}sidebar-mini{% endblock %}

{% block stylesheets %}
<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<link href="/static/assets/css/adminlte.min.css" rel="stylesheet">
<link href="/static/assets/css/mine.css" rel="stylesheet">
<link href="/static/assets/css/select2.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.css" rel="stylesheet">
<link href="https://cdn.datatables.net/responsive/2.3.0/css/responsive.dataTables.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/fixedcolumns/5.0.4/css/fixedColumns.dataTables.css" rel="stylesheet">

<style>
.alert-container { 
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
    z-index: 9999; width: 80%; display: none; 
}
.alert { opacity: 1; transition: opacity 1s ease-out; margin-bottom: 10px; }
.alert-dismissible { padding-right: 30px; }
.img-thumb { width: 100px; height: 100px; object-fit: cover; }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="container mt-3" id="flashMessageContainer">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            <strong>{{ message }}</strong>
            <button type="button" class="close" data-dismiss="alert">&times;</button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Page Header -->
  <section class="content-header">
    <div class="container-fluid">
      <div class="d-flex justify-content-between align-items-center">
        <h1>Fixed Assets</h1>
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a href="/index">Home</a></li>
          <li class="breadcrumb-item active">Fixed Assets</li>
        </ol>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <section class="content">
    <div class="container-fluid">
      <div class="card">
        <div class="card-header d-flex justify-content-between">
          <h3 class="card-title mb-0">Fixed Assets List</h3>
          <div>
            <a href="/add_fixed_asset" class="btn btn-primary btn-sm">
              <i class="fas fa-plus-circle"></i> Add Asset
            </a>
            <a id="exportExcelButton" class="btn btn-info btn-sm">
              <i class="fas fa-file-excel"></i> Export to Excel
            </a>
          </div>
        </div>

        <div class="card-body table-responsive">

          <!-- Filter Form -->
          <form method="get" class="mb-3">
            <div class="row">
              <div class="col-md-2 mb-2">
                <label for="identification_number">Identification #</label>
                <input type="text" name="identification_number" id="identification_number" class="form-control" value="{{ selected_filters.identification_number }}">
              </div>
              <div class="col-md-2 mb-2">
                <label for="serial_number">Serial #</label>
                <input type="text" name="serial_number" id="serial_number" class="form-control" value="{{ selected_filters.serial_number }}">
              </div>
              <div class="col-md-3 mb-2">
                <label for="description">Description</label>
                <input type="text" name="description" id="description" class="form-control" value="{{ selected_filters.description }}">
              </div>
              <div class="col-md-2 mb-2">
                <label for="department_id">Department</label>
                <select name="department_id" id="department_id" class="form-control select2">
                  <option value="">All</option>
                  {% for d in departments %}
                    <option value="{{ d.department_id }}" {% if selected_filters.department_id == d.department_id|string %}selected{% endif %}>{{ d.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-2 mb-2" id="section_container">
                <label for="section_id">Section</label>
                <select name="section_id" id="section_id" class="form-control select2">
                  <option value="">All</option>
                  {% for s in sections %}
                    {% if selected_filters.department_id == '' or s.department_id|string == selected_filters.department_id %}
                      <option value="{{ s.section_id }}" {% if selected_filters.section_id == s.section_id|string %}selected{% endif %}>{{ s.name }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="row mt-2">
              <div class="col-md-12">
                <button type="submit" class="btn btn-primary"><i class="fas fa-filter"></i> Filter</button>
                <a href="/fixed_assets" class="btn btn-secondary ml-2"><i class="fas fa-sync-alt"></i> Clear</a>
              </div>
            </div>
          </form>

          <!-- Assets Table -->
          <table id="assetsTable" class="display nowrap stripe" style="width:100%">
            <thead>
              <tr>
                <th>Identification #</th>
                <th>Serial #</th>
                <th>Description</th>
                <th>Department</th>
                <th>Section</th>
                <th>User</th>
                <th>Ownership</th>
                <th>Condition</th>
                <th>Image</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for asset in assets %}
                <tr>
                  <td>{{ asset.IdentificationNumber }}</td>
                  <td>{{ asset.SerialNumber }}</td>
                  <td>{{ asset.AssetDescription }}</td>
                  <td>{{ asset.department_name or '—' }}</td>
                  <td>{{ asset.section_name or '—' }}</td>
                  <td>{{ asset.user_name or '—' }}</td>
                  <td>{{ asset.OwnershipStatus }}</td>
                  <td>{{ asset.AssetCondition }}</td>
                  <td>
                    {% if asset.image %}
                      <img src="/static/uploads/{{ asset.image }}" class="img-thumb" alt="Asset Image">
                    {% else %}
                      <span>No Image</span>
                    {% endif %}
                  </td>
                  <td>
                    <a href="{{ url_for('fixed_assets_blueprint.edit_fixed_asset', asset_id=asset.AssetID) }}" class="btn btn-sm btn-primary mb-1">
                      <i class="fas fa-edit"></i> Edit
                    </a>
                    <button class="btn btn-sm btn-danger mb-1 delete-asset-btn" data-id="{{ asset.AssetID }}">
                      <i class="fas fa-trash-alt"></i> Delete
                    </button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

        </div>
      </div>
    </div>
  </section>
</div>
{% endblock %}

{% block javascripts %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/static/assets/js/adminlte.js"></script>
<script src="https://cdn.datatables.net/2.2.2/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/responsive/2.3.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/fixedcolumns/5.0.4/js/dataTables.fixedColumns.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
$(document).ready(function() {
  // Initialize DataTable
  $('#assetsTable').DataTable({
    fixedColumns: { left: 1, right: 1 },
    paging: false,
    scrollX: true,
    scrollY: '400px',
    scrollCollapse: true,
    stateSave: true
  });

  $('.select2').select2();

  // Export table to Excel
  $('#exportExcelButton').click(function(e) {
    e.preventDefault();
    const table = document.getElementById('assetsTable');
    const wb = XLSX.utils.book_new();
    const ws_data = Array.from(table.querySelectorAll('tr'))
      .map(row => Array.from(row.querySelectorAll('th, td')).map(c => c.innerText.trim()));
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, 'FixedAssets');
    XLSX.writeFile(wb, 'FixedAssets_List.xlsx');
  });

  // Dynamic Section Filtering
  let allSections = {{ sections|tojson }};
  $('#department_id').on('change', function() {
    const deptId = $(this).val();
    const sectionSelect = $('#section_id');
    sectionSelect.empty().append('<option value="">All</option>');
    allSections.forEach(s => {
      if (!deptId || s.department_id == deptId) {
        sectionSelect.append(`<option value="${s.section_id}">${s.name}</option>`);
      }
    });
  });

  // Delete Asset Confirmation
  $(document).on('click', '.delete-asset-btn', function() {
    const assetId = $(this).data('id');
    if (confirm('Are you sure you want to delete this asset? This action cannot be undone.')) {
      window.location.href = `/delete_fixed_asset/${assetId}`;
    }
  });
});
</script>
{% endblock %}
