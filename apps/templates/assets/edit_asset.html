{% extends "layouts/base.html" %}

{% block title %} Edit Asset: {{ asset.IdentificationNumber if asset else 'Loading...' }} {% endblock %}

{% block body_class %} sidebar-mini {% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
<link rel="stylesheet" href="/static/assets/plugins/fontawesome-free/css/all.min.css">
<link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
<link rel="stylesheet" href="/static/assets/css/adminlte.min.css">
<link rel="stylesheet" href="/static/assets/css/select2.min.css">
<style>
    .alert-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      width: 80%;
    }
    .required-label::after {
        content: " *";
        color: red;
    }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="content-wrapper">

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
      <div class="alert-container">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          <strong>{{ message }}</strong>
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    {% endwith %}

    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>Edit Asset: {{ asset.IdentificationNumber if asset else 'N/A' }}</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="/index">Home</a></li>
              <li class="breadcrumb-item"><a href="/assets">Assets Register</a></li>
              <li class="breadcrumb-item active">Edit Asset</li>
            </ol>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-8 offset-md-2 col-12">
            <div class="card card-warning"> <!-- Changed card style for editing -->
              <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title">Editing Asset: {{ asset.AssetDescription if asset else 'N/A' }}</h3>
                <div class="btn-group mb-2" role="group">
                  <a href="/assets" class="btn btn-primary btn-sm">View Assets</a>
                  <a href="/add_asset" class="btn btn-info btn-sm">Add New Asset</a>
                  <a href="/inventory_index" class="btn btn-success btn-sm">Inventory Dashboard</a>
                </div>
              </div>
              
              <div class="card-body">
                {% if asset %}
                <form action="{{ url_for('fixed_assets_blueprint.edit_asset', asset_id=asset.AssetID) }}" method="POST">
                  
                  <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="AssetID" value="{{ asset.AssetID }}">

                  <div class="row">
                    <!-- Column 1: Mandatory Identifiers -->
                    <div class="col-md-6">
                        <h5 class="text-primary mb-3"><i class="fas fa-barcode"></i> Identification</h5>

                        <div class="form-group mb-3">
                            <label class="control-label required-label" for="id-number">Identification Number:</label>
                            <input type="text" id="id-number" name="id_number" 
                                value="{{ asset.IdentificationNumber }}"
                                class="form-control form-control-sm border-info shadow-sm" required />
                        </div>

                        <div class="form-group mb-3">
                            <label class="control-label" for="serial-number">Serial Number:</label>
                            <input type="text" id="serial-number" name="serial_number" 
                                value="{{ asset.SerialNumber or '' }}"
                                class="form-control form-control-sm border-info shadow-sm" />
                        </div>
                        
                        <div class="form-group mb-3">
                            <label class="control-label required-label" for="description">Asset Description:</label>
                            <textarea id="description" name="description" 
                                class="form-control form-control-sm border-info shadow-sm" required rows="2">{{ asset.AssetDescription }}</textarea>
                        </div>
                        
                        <h5 class="text-primary mb-3 mt-4"><i class="fas fa-money-bill-wave"></i> Acquisition & Cost</h5>
                        
                        <div class="form-group mb-3">
                            <label class="control-label required-label" for="acquisition-date">Acquisition Date:</label>
                            <input type="date" id="acquisition-date" name="acquisition_date"
                                value="{{ asset.AcquisitionDate | date_format }}"
                                class="form-control form-control-sm border-info shadow-sm" required />
                        </div>

                        <div class="form-group mb-3">
                            <label class="control-label required-label" for="cost-valuation">Cost/Valuation:</label>
                            <input type="number" step="0.01" id="cost-valuation" name="cost_valuation" 
                                value="{{ asset.CostValuation }}"
                                class="form-control form-control-sm border-info shadow-sm" required />
                        </div>
                        
                    </div>

                    <!-- Column 2: Relationships and Status -->
                    <div class="col-md-6">
                        <h5 class="text-info mb-3"><i class="fas fa-sitemap"></i> Categorization & Location</h5>
                        
                        <div class="form-group mb-3">
                            <label class="control-label required-label" for="category-id">Category:</label>
                            <select id="category-id" name="category_id" class="form-control form-control-sm select2-simple border-info shadow-sm" required>
                                <option value="">Select Category...</option>
                                {% for category in categories %}
                                    <option value="{{ category.CategoryID }}" 
                                        {% if asset.CategoryID == category.CategoryID %}selected{% endif %}>
                                        {{ category.Name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label class="control-label required-label" for="location-id">Current Location:</label>
                            <select id="location-id" name="location_id" class="form-control form-control-sm select2-simple border-info shadow-sm" required>
                                <option value="">Select Location...</option>
                                {% for location in locations %}
                                    <option value="{{ location.LocationID }}"
                                        {% if asset.LocationID == location.LocationID %}selected{% endif %}>
                                        {{ location.LocationName }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label class="control-label" for="custodian-id">Custodian/Responsible Staff:</label>
                            <select id="custodian-id" name="custodian_id" class="form-control form-control-sm select2-simple border-info shadow-sm">
                                <option value="">Select Staff...</option>
                                {% for user in users %}
                                    <option value="{{ user.id }}"
                                        {% if asset.CustodianID == user.id %}selected{% endif %}>
                                        {{ user.last_name }}, {{ user.first_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label class="control-label" for="supplier-id">Supplier/Donor:</label>
                            <select id="supplier-id" name="supplier_id" class="form-control form-control-sm select2-simple border-info shadow-sm">
                                <option value="">Select Supplier/Donor...</option>
                                {% for supplier in suppliers %}
                                    <option value="{{ supplier.SupplierID }}"
                                        {% if asset.SupplierID == supplier.SupplierID %}selected{% endif %}>
                                        {{ supplier.Name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <h5 class="text-danger mb-3 mt-4"><i class="fas fa-info-circle"></i> Status</h5>
                        
                        {% set ownership_statuses = ['Owned', 'Leased', 'Trust'] %}
                        <div class="form-group mb-3">
                            <label class="control-label" for="ownership-status">Ownership Status:</label>
                            <select id="ownership-status" name="ownership_status" class="form-control form-control-sm border-info shadow-sm">
                                {% for status in ownership_statuses %}
                                    <option value="{{ status }}" 
                                        {% if asset.OwnershipStatus == status %}selected{% endif %}>
                                        {{ status }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        {% set asset_conditions = ['Good', 'Fair', 'Poor', 'Missing'] %}
                        <div class="form-group mb-3">
                            <label class="control-label" for="asset-condition">Asset Condition:</label>
                            <select id="asset-condition" name="asset_condition" class="form-control form-control-sm border-info shadow-sm">
                                {% for condition in asset_conditions %}
                                    <option value="{{ condition }}"
                                        {% if asset.AssetCondition == condition %}selected{% endif %}>
                                        {{ condition }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                    </div>
                  </div>

                  <div class="form-group text-right mt-4">
                    <button type="submit" class="btn btn-sm btn-success">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <a href="{{ url_for('fixed_assets_blueprint.assets') }}" class="btn btn-sm btn-secondary">Cancel</a>
                  </div>

                </form>
                {% else %}
                    <p class="text-danger">Asset data could not be loaded. Please return to the asset list.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
</div>
{% endblock content %}

{% block javascripts %}
<script src="/static/assets/plugins/jquery/jquery.min.js"></script>
<script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/static/assets/js/adminlte.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
<script>
    // Simple custom filter for date formatting (needed if you don't have this available globally in Flask/Jinja)
    // This assumes your date is passed as a Python date object or string that needs conversion for the input[type=date] value.
    // If Flask filters are set up, you can remove this.
    function formatDate(dateString) {
        if (!dateString) return '';
        if (dateString instanceof Date) {
            return dateString.toISOString().split('T')[0];
        }
        // Assuming the date string is already in YYYY-MM-DD format if it came from the DB
        return dateString.split(' ')[0]; 
    }

    $(document).ready(function() {
        // Initialize Select2 on all necessary dropdowns
        $('.select2-simple').select2({
            theme: 'bootstrap4',
            width: '100%'
        });
        
        // Handle date input (ensure value is correctly formatted YYYY-MM-DD)
        const acquisitionDate = '{{ asset.AcquisitionDate or '' }}';
        if (acquisitionDate) {
             // Assuming your asset.AcquisitionDate comes as a clean YYYY-MM-DD string or a date object that Jinja formats correctly.
             $('#acquisition-date').val(formatDate(acquisitionDate));
        }

        // Flash message fade-in and fade-out effect
        if ($('.alert-container').length) {
            $('.alert-container').fadeIn(500).delay(3000).fadeOut(1000);
        }
    });
</script>
{% endblock javascripts %}